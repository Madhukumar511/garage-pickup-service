<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoTrack | Resident Dashboard</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: { 50: '#f0fdf4', 100: '#dcfce7', 400: '#4ade80', 500: '#22c55e', 600: '#16a34a', 700: '#15803d', 900: '#14532d' },
                        midnight: '#0f172a', 
                        darkbg: '#0f172a',
                        darkcard: '#1e293b'
                    },
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    animation: {
                        'gradient-xy': 'gradient-xy 6s ease infinite',
                    },
                    keyframes: {
                        'gradient-xy': {
                            '0%, 100%': { 'background-size': '200% 200%', 'background-position': 'left center' },
                            '50%': { 'background-size': '200% 200%', 'background-position': 'right center' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Outfit', sans-serif; transition: background-color 0.3s, color 0.3s; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .nav-btn { width: 100%; display: flex; align-items: center; padding: 0.75rem 2rem; transition: all 0.2s; font-weight: 500; color: #64748b; }
        .nav-btn:hover { background-color: #f8fafc; color: #16a34a; }
        .dark .nav-btn:hover { background-color: #1e293b; color: #4ade80; }
        .nav-btn.active { background-color: #f0fdf4; color: #16a34a; border-right: 3px solid #16a34a; }
        .dark .nav-btn.active { background-color: #1e293b; color: #4ade80; border-right: 3px solid #4ade80; }
        
        .nav-btn-report { color: #ef4444; border-top: 1px solid #f1f5f9; margin-top: 10px; }
        .nav-btn-report:hover { background-color: #fef2f2; color: #dc2626; }
        .dark .nav-btn-report { color: #f87171; border-color: #334155; }
        .nav-btn-report.active { background-color: #fef2f2; color: #dc2626; border-right: 3px solid #dc2626; }

        #sidebar-overlay.open { opacity: 1; pointer-events: auto; }
        
        input[type=range] { appearance: none; -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: #22c55e; border: 4px solid white; cursor: pointer; margin-top: -10px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; cursor: pointer; background: #e2e8f0; border-radius: 999px; }
        .dark input[type=range]::-webkit-slider-runnable-track { background: #334155; }

        .search-results {
            max-height: 200px; overflow-y: auto; position: absolute; width: 100%; z-index: 50;
            background: white; border-radius: 0.75rem; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            margin-top: 0.5rem; border: 1px solid #e2e8f0;
        }
        .dark .search-results { background: #1e293b; border-color: #334155; }
        .search-item { padding: 1rem; cursor: pointer; font-size: 0.9rem; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; }
        .dark .search-item { border-color: #334155; color: #cbd5e1; }
        .search-item:hover { background-color: #f0fdf4; color: #15803d; }
        .dark .search-item:hover { background-color: #0f172a; color: #4ade80; }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        .level-progress-container { width: 100%; background-color: #e2e8f0; border-radius: 999px; height: 10px; overflow: hidden; }
        .dark .level-progress-container { background-color: #334155; }
        .level-progress-bar { height: 100%; background: linear-gradient(90deg, #22c55e, #16a34a); transition: width 0.5s ease; }
        
        .tab-btn.active { border-bottom: 2px solid #22c55e; color: #16a34a; background: #f0fdf4; }
        .dark .tab-btn.active { color: #4ade80; background: #1e293b; }

        /* Status Tracker Styles */
        .step-active .step-dot { background-color: #22c55e; border-color: #22c55e; color: white; box-shadow: 0 0 15px rgba(34, 197, 94, 0.5); }
        .step-completed .step-dot { background-color: #16a34a; border-color: #16a34a; color: white; }
        .step-line-active { background-color: #22c55e; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-darkbg h-screen flex overflow-hidden text-slate-800 dark:text-slate-200">

    <div id="redeem-modal" class="hidden fixed inset-0 z-[80] bg-black/90 flex items-center justify-center p-4 fade-in backdrop-blur-md">
        <div class="bg-white dark:bg-slate-900 rounded-3xl max-w-sm w-full relative overflow-hidden shadow-2xl">
            <div class="h-32 bg-gradient-to-br from-brand-500 to-emerald-700 flex items-center justify-center">
                <i class="fas fa-gift text-6xl text-white drop-shadow-lg animate-bounce"></i>
            </div>
            <div class="p-8 text-center">
                <h2 class="text-2xl font-bold text-midnight dark:text-white mb-1" id="redeem-title">Reward Name</h2>
                <p class="text-sm text-slate-500 mb-6">Redemption Successful!</p>
                <div class="bg-slate-100 dark:bg-slate-800 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-xl p-4 mb-6 relative group cursor-pointer" onclick="app.copyCode()">
                    <p class="text-[10px] text-slate-400 uppercase font-bold mb-1">Your Coupon Code</p>
                    <div class="text-2xl font-mono font-black text-brand-600 dark:text-brand-400 tracking-widest" id="redeem-code">ECO-XXXX</div>
                    <div class="absolute inset-0 bg-black/5 dark:bg-white/5 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center rounded-xl">
                        <span class="text-xs font-bold text-slate-600 dark:text-slate-300"><i class="fas fa-copy"></i> Copy</span>
                    </div>
                </div>
                <div class="text-left text-xs text-slate-400 space-y-2 mb-6 bg-slate-50 dark:bg-slate-800/50 p-4 rounded-lg">
                    <p class="font-bold text-slate-500">Terms & Conditions:</p>
                    <ul class="list-disc pl-4 space-y-1">
                        <li>Valid for 30 days from today.</li>
                        <li>Cannot be combined with other offers.</li>
                        <li>One-time use only.</li>
                    </ul>
                </div>
                <button onclick="document.getElementById('redeem-modal').classList.add('hidden'); document.getElementById('redeem-modal').classList.remove('flex')" class="w-full py-3 bg-midnight hover:bg-slate-800 text-white font-bold rounded-xl">Close</button>
            </div>
        </div>
    </div>

    <div id="level-modal" class="hidden fixed inset-0 z-[80] bg-black/80 flex items-center justify-center p-4 fade-in backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-900 rounded-3xl p-6 max-w-sm w-full relative shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg dark:text-white">How Levels Work</h3>
                <button onclick="document.getElementById('level-modal').classList.add('hidden')" class="text-slate-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-4">
                <div class="flex items-center gap-3 p-3 bg-slate-50 dark:bg-slate-800 rounded-xl border border-slate-100 dark:border-slate-700">
                    <div class="w-10 h-10 bg-slate-200 rounded-full flex items-center justify-center text-xl">üå±</div>
                    <div><div class="font-bold text-sm dark:text-white">Seed</div><div class="text-xs text-slate-500">0 - 999 Points</div></div>
                </div>
                <div class="flex items-center gap-3 p-3 bg-green-50 dark:bg-green-900/20 rounded-xl border border-green-100 dark:border-green-800">
                    <div class="w-10 h-10 bg-green-200 rounded-full flex items-center justify-center text-xl">üåø</div>
                    <div><div class="font-bold text-sm dark:text-white">Sapling</div><div class="text-xs text-slate-500">1,000 - 4,999 Points</div></div>
                </div>
                <div class="flex items-center gap-3 p-3 bg-emerald-50 dark:bg-emerald-900/20 rounded-xl border border-emerald-100 dark:border-emerald-800">
                    <div class="w-10 h-10 bg-emerald-200 rounded-full flex items-center justify-center text-xl">üå≥</div>
                    <div><div class="font-bold text-sm dark:text-white">Tree</div><div class="text-xs text-slate-500">5,000 - 19,999 Points</div></div>
                </div>
                 <div class="flex items-center gap-3 p-3 bg-teal-50 dark:bg-teal-900/20 rounded-xl border border-teal-100 dark:border-teal-800">
                    <div class="w-10 h-10 bg-teal-200 rounded-full flex items-center justify-center text-xl">üèûÔ∏è</div>
                    <div><div class="font-bold text-sm dark:text-white">Forest</div><div class="text-xs text-slate-500">20,000+ Points</div></div>
                </div>
            </div>
        </div>
    </div>

    <div id="active-order-modal" class="hidden fixed inset-0 z-[60] bg-black/80 flex items-center justify-center p-4 fade-in backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-900 rounded-3xl p-8 max-w-sm w-full text-center relative overflow-hidden shadow-2xl">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-brand-400 to-green-600"></div>
            <div class="w-20 h-20 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-6 text-4xl shadow-sm">üöö</div>
            <h2 class="text-2xl font-bold text-midnight dark:text-white mb-2">Hold on!</h2>
            <p class="text-slate-500 dark:text-slate-400 text-sm mb-8 leading-relaxed">You already have an active pickup. Only one order allowed at a time.</p>
            <div class="flex flex-col gap-3">
                <button onclick="document.getElementById('active-order-modal').classList.add('hidden'); document.getElementById('active-order-modal').classList.remove('flex')" class="w-full py-3.5 bg-brand-600 hover:bg-brand-700 text-white rounded-xl font-bold">Okay, I'll wait</button>
            </div>
        </div>
    </div>

    <div id="success-modal" class="hidden fixed inset-0 z-[70] bg-black/90 flex items-center justify-center p-4 fade-in backdrop-blur-md">
        <div class="text-center">
            <div class="w-24 h-24 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-6 text-5xl text-white shadow-2xl shadow-green-500/50 animate-bounce">
                <i class="fas fa-check"></i>
            </div>
            <h2 class="text-4xl font-extrabold text-white mb-2">Awesome!</h2>
            <p class="text-green-200 text-lg mb-8">Pickup Scheduled Successfully.</p>
            <div class="bg-white/10 backdrop-blur-sm rounded-xl p-6 max-w-xs mx-auto border border-white/20">
                <p class="text-xs text-slate-300 uppercase font-bold tracking-widest mb-1">Estimated Earnings</p>
                <p class="text-3xl font-bold text-green-400" id="success-points">0 Pts</p>
            </div>
            <button onclick="app.closeSuccessModal()" class="mt-8 px-8 py-3 bg-white text-green-900 font-bold rounded-xl hover:bg-green-50 transition-colors">Okay, Got it!</button>
        </div>
    </div>

    <div id="report-success-modal" class="hidden fixed inset-0 z-[70] bg-black/95 flex items-center justify-center p-4 fade-in backdrop-blur-md">
        <div class="text-center max-w-md w-full relative">
            <div class="w-28 h-28 bg-gradient-to-br from-red-500 to-orange-500 rounded-full flex items-center justify-center mx-auto mb-6 text-5xl text-white shadow-red-500/50 shadow-2xl animate-pulse">
                <i class="fas fa-shield-alt"></i>
            </div>
            <h2 class="text-4xl font-extrabold text-white mb-2">HERO ALERT! ü¶∏</h2>
            <p class="text-slate-300 text-lg mb-6">Thank you for reporting this dump!</p>
            <div class="bg-slate-800/80 p-6 rounded-2xl border border-slate-700 text-left mb-6">
                <p class="text-sm text-slate-400 mb-2">Our cleanup crew has been notified. We will update you once the area is clean.</p>
                <div class="flex items-center gap-2 text-yellow-400 font-bold text-sm">
                    <i class="fas fa-star"></i> You just made your city cleaner!
                </div>
            </div>
            <button onclick="app.closeReportModal()" class="w-full py-4 bg-white text-midnight font-bold rounded-xl hover:bg-slate-100 transition-colors uppercase tracking-wider">Continue Being Awesome</button>
        </div>
    </div>

    <div id="cancel-modal" class="hidden fixed inset-0 z-[60] bg-black/80 flex items-center justify-center p-4 fade-in backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-900 rounded-3xl p-6 max-w-sm w-full relative overflow-hidden shadow-2xl">
            <h2 class="text-xl font-bold text-midnight dark:text-white mb-4">Cancel Pickup?</h2>
            <form onsubmit="app.submitCancellation(event)">
                <div class="space-y-3 mb-6">
                    <label class="flex items-center gap-3 p-3 border border-slate-200 dark:border-slate-700 rounded-xl cursor-pointer">
                        <input type="radio" name="cancelReason" value="Changed my mind" checked class="w-4 h-4 text-brand-600"><span class="text-sm font-medium">Changed my mind</span>
                    </label>
                    <label class="flex items-center gap-3 p-3 border border-slate-200 dark:border-slate-700 rounded-xl cursor-pointer">
                        <input type="radio" name="cancelReason" value="Driver delayed" class="w-4 h-4 text-brand-600"><span class="text-sm font-medium">Driver taking too long</span>
                    </label>
                </div>
                <div class="flex gap-3">
                    <button type="button" onclick="document.getElementById('cancel-modal').classList.add('hidden')" class="flex-1 py-3 text-sm font-bold text-slate-500 hover:bg-slate-100 rounded-xl">Keep Order</button>
                    <button type="submit" class="flex-1 py-3 bg-red-500 hover:bg-red-600 text-white text-sm font-bold rounded-xl">Confirm Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div id="details-modal" class="hidden fixed inset-0 z-[60] bg-black/80 flex items-center justify-center p-4 fade-in backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-900 rounded-3xl p-6 max-w-md w-full relative shadow-2xl flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-start mb-6 border-b border-slate-100 dark:border-slate-800 pb-4">
                <div><h2 class="text-xl font-bold text-midnight dark:text-white">Order Details</h2><p class="text-xs text-slate-500" id="detail-id">ID: #---</p></div>
                <button onclick="document.getElementById('details-modal').classList.add('hidden')" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-slate-500 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-4 overflow-y-auto flex-1 pr-2">
                <div class="flex items-center gap-4 p-4 bg-slate-50 dark:bg-slate-800 rounded-xl">
                    <div id="detail-icon" class="w-12 h-12 rounded-full bg-white dark:bg-slate-700 flex items-center justify-center text-2xl">üì¶</div>
                    <div><div class="font-bold text-lg dark:text-white" id="detail-type">Type</div><div class="text-xs text-slate-500" id="detail-condition">Condition: --</div></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="p-3 border border-slate-100 dark:border-slate-700 rounded-xl"><div class="text-[10px] uppercase font-bold text-slate-400">Weight</div><div class="font-bold text-lg dark:text-white" id="detail-weight">0 kg</div></div>
                    <div class="p-3 border border-slate-100 dark:border-slate-700 rounded-xl"><div class="text-[10px] uppercase font-bold text-slate-400">Est. Price</div><div class="font-bold text-lg text-green-600" id="detail-price">‚Çπ0</div></div>
                </div>
                <div><div class="text-xs font-bold text-slate-500 uppercase mb-1">Address</div><div class="font-medium dark:text-slate-300 text-sm" id="detail-address">--</div></div>
            </div>
        </div>
    </div>

    <div id="sidebar-overlay" onclick="app.toggleSidebar()" class="fixed inset-0 bg-black/50 z-40 opacity-0 pointer-events-none transition-opacity duration-300 md:hidden backdrop-blur-sm"></div>

    <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-white dark:bg-darkcard border-r border-slate-200 dark:border-slate-700 flex flex-col transform -translate-x-full transition-transform duration-300 md:translate-x-0 md:static">
        <div class="h-20 flex items-center justify-between px-8 border-b border-slate-100 dark:border-slate-700">
            <div class="flex items-center">
                <div class="w-8 h-8 bg-brand-500 rounded-lg flex items-center justify-center text-white mr-3 shadow-lg"><i class="fas fa-leaf"></i></div>
                <span class="font-bold text-xl text-midnight dark:text-white tracking-tight">EcoTrack</span>
            </div>
            <button onclick="app.toggleSidebar()" class="md:hidden text-slate-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
        </div>

        <nav class="flex-1 overflow-y-auto py-6 space-y-1">
            <button onclick="app.switchView('dashboard')" id="nav-dashboard" class="nav-btn active"><i class="fas fa-home w-6"></i> Dashboard</button>
            <button onclick="app.switchView('schedule')" id="nav-schedule" class="nav-btn"><i class="fas fa-calendar-plus w-6"></i> Schedule Pickup</button>
            <button onclick="app.switchView('history')" id="nav-history" class="nav-btn"><i class="fas fa-history w-6"></i> History</button>
            <button onclick="app.switchView('rewards-hub')" id="nav-rewards-hub" class="nav-btn"><i class="fas fa-trophy w-6"></i> Rewards & Impact</button>
            <button onclick="app.switchView('analytics')" id="nav-analytics" class="nav-btn"><i class="fas fa-chart-pie w-6"></i> Analytics</button>
            <button onclick="app.switchView('settings')" id="nav-settings" class="nav-btn"><i class="fas fa-cog w-6"></i> Settings</button>
            
            <button onclick="app.switchView('report')" id="nav-report" class="nav-btn nav-btn-report font-bold">
                <i class="fas fa-exclamation-triangle w-6 animate-pulse"></i> Report Dump
            </button>
        </nav>

        <div class="p-4 border-t border-slate-100 dark:border-slate-700">
            <button onclick="app.logout()" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-slate-50 dark:bg-slate-800 hover:bg-red-50 text-slate-600 dark:text-slate-400 hover:text-red-600 rounded-xl transition-colors font-bold text-sm">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </aside>

    <div class="flex-1 flex flex-col h-full relative">
        <header class="h-20 bg-white/80 dark:bg-darkcard/80 backdrop-blur-md border-b border-slate-200 dark:border-slate-700 flex items-center justify-between px-6 md:px-8 z-10">
            <div class="flex items-center gap-4">
                <button class="md:hidden text-slate-500 dark:text-slate-400 p-2 -ml-2 hover:bg-slate-100 rounded-lg" onclick="app.toggleSidebar()">
                    <i class="fas fa-bars text-xl"></i>
                </button>
            </div>
            <div class="flex items-center gap-4 md:gap-6">
                <div class="hidden lg:flex items-center gap-4 text-right border-r border-slate-200 dark:border-slate-700 pr-6">
                    <div>
                        <div id="clock-time" class="text-xl font-bold text-midnight dark:text-white font-mono leading-none">--:--:--</div>
                        <div id="clock-date" class="text-xs text-slate-500 dark:text-slate-400 font-medium mt-1">---</div>
                    </div>
                    <div class="bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-100 dark:border-emerald-800 rounded-xl p-2 flex flex-col items-center min-w-[70px]">
                        <div class="text-[10px] uppercase font-bold text-emerald-600 dark:text-emerald-400 leading-none mb-1">Score</div>
                        <div class="text-xl font-black text-emerald-600 dark:text-emerald-400 leading-none" id="green-score">--</div>
                    </div>
                </div>

                <div class="hidden md:block text-right">
                    <div class="text-xs font-bold text-slate-400 uppercase">EcoPoints</div>
                    <div class="text-lg font-bold text-brand-600 dark:text-brand-400" id="header-points">0</div>
                </div>

                <div class="relative">
                    <button onclick="app.toggleNotifications()" class="w-10 h-10 rounded-full bg-slate-50 dark:bg-slate-800 text-slate-600 dark:text-slate-300 flex items-center justify-center transition-colors relative hover:bg-slate-100 dark:hover:bg-slate-700">
                        <i class="fas fa-bell"></i>
                        <span id="notif-badge" class="hidden absolute top-0 right-0 w-3 h-3 bg-red-500 border-2 border-white dark:border-darkcard rounded-full animate-pulse"></span>
                    </button>
                    
                    <div id="notif-menu" class="hidden absolute right-0 mt-3 w-80 bg-white dark:bg-darkcard rounded-2xl shadow-2xl z-50 overflow-hidden border border-slate-100 dark:border-slate-700 animate-in fade-in zoom-in-95 duration-200">
                        <div class="p-4 border-b border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 flex justify-between items-center">
                            <h4 class="font-bold text-sm text-midnight dark:text-white">Notifications</h4>
                            <span class="text-[10px] font-bold text-brand-600 cursor-pointer hover:underline" onclick="app.clearNotifications()">Clear All</span>
                        </div>
                        <div id="notif-list" class="max-h-64 overflow-y-auto">
                            <div class="p-6 text-center text-slate-400 text-xs">No new notifications</div>
                        </div>
                    </div>
                    <div id="notif-overlay" onclick="app.toggleNotifications()" class="hidden fixed inset-0 z-40 bg-transparent cursor-default"></div>
                </div>

                <button onclick="app.toggleDarkMode()" class="w-10 h-10 rounded-full bg-slate-50 dark:bg-slate-800 text-slate-600 dark:text-yellow-400 flex items-center justify-center transition-colors">
                    <i class="fas fa-moon dark:hidden"></i><i class="fas fa-sun hidden dark:block"></i>
                </button>
                <div class="relative">
                    <button onclick="app.toggleProfileMenu()" class="w-10 h-10 rounded-full bg-brand-100 text-brand-600 flex items-center justify-center font-bold border-2 border-white shadow-sm">
                        <span id="avatar">U</span>
                    </button>
                     <div id="profile-menu" class="hidden absolute right-0 mt-3 w-72 bg-white dark:bg-darkcard rounded-2xl shadow-2xl z-50 overflow-hidden">
                         <div class="p-6 bg-gradient-to-br from-brand-500 to-brand-600 text-white">
                            <h4 class="font-bold text-lg" id="dropdown-name">Loading...</h4>
                            <p class="text-xs text-brand-100" id="dropdown-email">loading...</p>
                        </div>
                        <div class="p-2">
                            <button onclick="app.logout()" class="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium text-red-600 hover:bg-red-50 rounded-xl">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </button>
                        </div>
                    </div>
                    <div id="profile-overlay" onclick="app.toggleProfileMenu()" class="hidden fixed inset-0 z-40 bg-transparent cursor-default"></div>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-4 md:p-6 relative scroll-smooth">
            
            <div id="view-dashboard" class="fade-in">
                <div id="active-status-tracker" class="hidden mb-6 bg-white dark:bg-darkcard rounded-3xl p-6 shadow-md border border-brand-100 dark:border-brand-900/30">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-lg text-midnight dark:text-white flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> Live Pickup Status
                        </h3>
                        <span class="text-xs font-mono text-slate-500" id="tracker-id">#ID</span>
                    </div>
                    <div class="relative px-2 md:px-6">
                        <div class="absolute top-3 left-6 right-6 h-1 bg-slate-100 dark:bg-slate-700 rounded-full -z-0"></div>
                        <div id="tracker-line" class="absolute top-3 left-6 h-1 bg-brand-500 rounded-full transition-all duration-700 -z-0" style="width: 0%"></div>
                        
                        <div class="flex justify-between relative z-10">
                            <div class="flex flex-col items-center gap-2 step-item" id="step-pending">
                                <div class="w-7 h-7 rounded-full bg-slate-200 dark:bg-slate-700 border-2 border-white dark:border-darkcard text-slate-400 flex items-center justify-center text-[10px] step-dot transition-all duration-300"><i class="fas fa-hourglass-start"></i></div>
                                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Pending</span>
                            </div>
                            <div class="flex flex-col items-center gap-2 step-item" id="step-assigned">
                                <div class="w-7 h-7 rounded-full bg-slate-200 dark:bg-slate-700 border-2 border-white dark:border-darkcard text-slate-400 flex items-center justify-center text-[10px] step-dot transition-all duration-300"><i class="fas fa-user-check"></i></div>
                                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Assigned</span>
                            </div>
                            <div class="flex flex-col items-center gap-2 step-item" id="step-arrived">
                                <div class="w-7 h-7 rounded-full bg-slate-200 dark:bg-slate-700 border-2 border-white dark:border-darkcard text-slate-400 flex items-center justify-center text-[10px] step-dot transition-all duration-300"><i class="fas fa-truck-fast"></i></div>
                                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Arrived</span>
                            </div>
                            <div class="flex flex-col items-center gap-2 step-item" id="step-completed">
                                <div class="w-7 h-7 rounded-full bg-slate-200 dark:bg-slate-700 border-2 border-white dark:border-darkcard text-slate-400 flex items-center justify-center text-[10px] step-dot transition-all duration-300"><i class="fas fa-check"></i></div>
                                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Done</span>
                            </div>
                        </div>
                    </div>
                    <div id="tracker-msg" class="mt-6 p-3 bg-brand-50 dark:bg-brand-900/10 rounded-xl text-xs text-brand-800 dark:text-brand-300 flex items-start gap-2 hidden">
                        <i class="fas fa-comment-alt mt-0.5"></i>
                        <div><span class="font-bold">Driver Message:</span> <span id="tracker-msg-text">--</span></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-6">
                    <div class="lg:col-span-3 bg-midnight text-white rounded-3xl p-6 shadow-lg flex flex-col justify-center relative overflow-hidden">
                        <div class="relative z-10">
                            <h1 class="text-2xl font-bold mb-2">Welcome back, <span id="header-username" class="text-brand-400">User</span>!</h1>
                            <p class="text-slate-300 max-w-lg mb-4 text-xs leading-relaxed">Your recycling efforts have saved <span class="text-brand-400 font-bold" id="dash-co2-preview">0</span> kg of CO2 this month. Keep up the great work!</p>
                            <div class="flex gap-3">
                                <button onclick="app.switchView('schedule')" class="bg-brand-500 hover:bg-brand-600 text-white px-5 py-2.5 rounded-xl font-bold transition-all shadow-lg shadow-brand-500/30 flex items-center gap-2 text-sm">
                                    <i class="fas fa-truck"></i> Schedule Pickup
                                </button>
                                <button onclick="app.switchView('rewards-hub')" class="bg-slate-700 hover:bg-slate-600 text-white px-5 py-2.5 rounded-xl font-bold transition-all text-sm">
                                    View Rewards
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-1 bg-gradient-to-br from-blue-500 to-indigo-600 animate-gradient-xy text-white rounded-3xl p-5 shadow-md flex flex-col justify-between">
                        <div class="flex justify-between items-start mb-2">
                            <div class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center text-white"><i class="fas fa-recycle"></i></div>
                            <span class="text-[10px] font-bold uppercase tracking-wider opacity-80">Completed</span>
                        </div>
                        <div>
                            <div class="text-3xl font-bold mb-1" id="stat-pickups">0</div>
                            <div class="text-[10px] opacity-80">Total Pickups</div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-gradient-to-br from-emerald-500 to-teal-600 animate-gradient-xy text-white rounded-3xl p-5 shadow-md flex flex-col justify-between">
                        <div class="flex justify-between items-start mb-4">
                            <div class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center text-white"><i class="fas fa-leaf"></i></div>
                            <span class="text-[10px] font-bold uppercase tracking-wider opacity-80">Points</span>
                        </div>
                        <div>
                            <div class="text-3xl font-bold" id="stat-points">0</div>
                            <div class="text-[10px] opacity-80 mt-1">Available Balance</div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-orange-400 to-pink-500 animate-gradient-xy text-white rounded-3xl p-5 shadow-md flex flex-col justify-between">
                        <div class="flex justify-between items-start mb-4">
                            <div class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center text-white"><i class="fas fa-wallet"></i></div>
                            <span class="text-[10px] font-bold uppercase tracking-wider opacity-80">Wallet</span>
                        </div>
                        <div>
                            <div class="text-3xl font-bold" id="stat-cash">‚Çπ0</div>
                            <div class="text-[10px] opacity-80 mt-1">Redeemable Cash</div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-darkcard border border-brand-200 dark:border-slate-700 text-slate-800 dark:text-white rounded-3xl p-5 shadow-sm flex flex-col justify-center items-center text-center cursor-pointer hover:border-brand-500 transition-colors group" onclick="app.switchView('report')">
                        <div class="w-10 h-10 bg-red-50 dark:bg-red-900/20 text-red-500 rounded-full flex items-center justify-center text-lg mb-2 group-hover:scale-110 transition-transform"><i class="fas fa-camera"></i></div>
                        <h3 class="font-bold text-sm mb-1">Spot a Dump?</h3>
                        <p class="text-[10px] text-slate-500 mb-3 px-2">Report illegal dumping and earn karma points.</p>
                        <span class="text-[10px] font-bold text-brand-600 uppercase tracking-wider group-hover:underline">Report Now <i class="fas fa-arrow-right ml-1"></i></span>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white dark:bg-darkcard rounded-3xl border border-slate-100 dark:border-slate-700 overflow-hidden shadow-sm h-fit">
                        <div class="p-5 border-b border-slate-100 dark:border-slate-700 font-bold text-midnight dark:text-white flex justify-between items-center text-sm">
                            <span class="flex items-center gap-2"><i class="fas fa-history text-slate-400"></i> Recent Activity</span>
                            <button onclick="app.switchView('history')" class="text-brand-600 text-xs hover:underline font-bold">View All</button>
                        </div>
                        <div id="dashboard-activity-list" class="p-3 space-y-2">
                        </div>
                    </div>

                    <div class="bg-white dark:bg-darkcard rounded-3xl border border-slate-100 dark:border-slate-700 overflow-hidden shadow-sm p-5 h-fit">
                        <h3 class="font-bold text-midnight dark:text-white mb-4 text-sm">Your Impact</h3>
                        <div class="space-y-5">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-xl bg-green-100 dark:bg-green-900/30 text-green-600 flex items-center justify-center text-lg"><i class="fas fa-tree"></i></div>
                                <div><div class="font-bold text-lg dark:text-white" id="dash-trees">0</div><div class="text-[10px] text-slate-500 font-medium">Trees Saved</div></div>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-xl bg-blue-100 dark:bg-blue-900/30 text-blue-600 flex items-center justify-center text-lg"><i class="fas fa-tint"></i></div>
                                <div><div class="font-bold text-lg dark:text-white" id="dash-water">0 L</div><div class="text-[10px] text-slate-500 font-medium">Water Conserved</div></div>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-xl bg-orange-100 dark:bg-orange-900/30 text-orange-600 flex items-center justify-center text-lg"><i class="fas fa-bolt"></i></div>
                                <div><div class="font-bold text-lg dark:text-white" id="dash-energy">0 kWh</div><div class="text-[10px] text-slate-500 font-medium">Energy Saved</div></div>
                            </div>
                        </div>
                        <button onclick="app.switchView('analytics')" class="w-full mt-6 py-3 border border-slate-200 dark:border-slate-600 rounded-xl text-xs font-bold text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">View Full Analytics</button>
                    </div>
                </div>
            </div>

            <div id="view-rewards-hub" class="hidden fade-in">
                <div class="flex gap-4 mb-6 border-b border-slate-200 dark:border-slate-700 overflow-x-auto pb-2 scrollbar-hide">
                    <button onclick="app.switchHubTab('leaderboard')" id="tab-leaderboard" class="tab-btn px-6 py-3 font-bold text-slate-500 transition-all rounded-t-lg hover:bg-slate-50 dark:hover:bg-slate-800 whitespace-nowrap">üèÜ Community Leaderboard</button>
                    <button onclick="app.switchHubTab('rewards')" id="tab-rewards" class="tab-btn active px-6 py-3 font-bold text-slate-500 transition-all rounded-t-lg hover:bg-slate-50 dark:hover:bg-slate-800 whitespace-nowrap">üéÅ Rewards Store</button>
                </div>

                <div id="hub-content-leaderboard" class="hidden">
                    <div class="bg-gradient-to-r from-violet-600 to-indigo-600 rounded-2xl p-8 text-white mb-8 text-center shadow-lg relative overflow-hidden">
                        <div class="relative z-10">
                            <h2 class="text-3xl font-bold mb-2">Eco Warriors üèÜ</h2>
                            <p class="text-indigo-100">Top recyclers making a difference in the city.</p>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-darkcard rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden max-w-4xl mx-auto">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-slate-50 dark:bg-slate-800 border-b border-slate-100 dark:border-slate-700">
                                    <tr>
                                        <th class="p-4 text-xs font-bold text-slate-500 uppercase">Rank</th>
                                        <th class="p-4 text-xs font-bold text-slate-500 uppercase">User</th>
                                        <th class="p-4 text-xs font-bold text-slate-500 uppercase text-right">Pickups</th>
                                        <th class="p-4 text-xs font-bold text-slate-500 uppercase text-right">EcoPoints</th>
                                    </tr>
                                </thead>
                                <tbody id="leaderboard-body">
                                    <tr><td colspan="4" class="p-6 text-center text-slate-400">Loading champions...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="hub-content-rewards" class="">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-gradient-to-r from-midnight to-slate-900 rounded-2xl p-8 text-white shadow-xl relative overflow-hidden md:col-span-1">
                            <div class="relative z-10">
                                <p class="text-slate-400 text-sm font-bold uppercase tracking-wider mb-2">Wallet</p>
                                <h2 class="text-4xl font-bold mb-2">‚Çπ<span id="rewards-cash">0</span></h2>
                                <p class="text-brand-400 text-sm font-bold"><i class="fas fa-coins"></i> <span id="rewards-points">0</span> Pts</p>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-darkcard rounded-2xl p-6 shadow-sm border border-slate-100 dark:border-slate-700 md:col-span-2">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold text-lg dark:text-white flex items-center gap-2">
                                    Current Status: <span id="level-name" class="text-brand-600">Seed üå±</span>
                                    <button onclick="document.getElementById('level-modal').classList.remove('hidden'); document.getElementById('level-modal').classList.add('flex')" class="text-slate-400 hover:text-brand-500"><i class="fas fa-info-circle text-sm"></i></button>
                                </h3>
                                <span class="text-xs text-slate-500 dark:text-slate-400" id="level-next">Next: Sapling (1000 Pts)</span>
                            </div>
                            <div class="level-progress-container mb-4">
                                <div class="level-progress-bar" id="level-bar" style="width: 0%"></div>
                            </div>
                            <p class="text-xs text-slate-500">Earn more points to unlock exclusive "Nature Terms" badges and higher conversion rates!</p>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-darkcard rounded-2xl p-6 shadow-sm border border-slate-100 dark:border-slate-700 mb-8">
                        <h3 class="font-bold text-lg dark:text-white mb-4">Currency Exchange</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Convert Points to Cash</label>
                                <div class="flex gap-4 items-center">
                                    <input type="number" id="convert-input" placeholder="Points" class="w-full px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-800">
                                    <i class="fas fa-arrow-right text-slate-400"></i>
                                    <div class="font-bold text-green-600">‚Çπ<span id="convert-preview">0</span></div>
                                </div>
                                <p class="text-[10px] text-slate-400 mt-1">Rate: 100 Pts = ‚Çπ1</p>
                                <button onclick="app.convertPoints()" class="mt-3 px-4 py-2 bg-brand-600 text-white rounded-lg text-sm font-bold hover:bg-brand-700">Convert</button>
                            </div>
                            <div class="border-t md:border-t-0 md:border-l border-slate-100 dark:border-slate-700 pt-6 md:pt-0 md:pl-8">
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Withdraw to UPI</label>
                                <input type="text" id="upi-id" placeholder="example@okhdfc" class="w-full px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-800 mb-3">
                                <button onclick="app.withdrawUPI()" class="w-full px-4 py-2 bg-midnight text-white rounded-lg text-sm font-bold hover:bg-slate-800">Withdraw Balance</button>
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-2 mb-6 overflow-x-auto pb-2 scrollbar-hide">
                         <button onclick="app.filterRewards('all', this)" class="filter-btn active px-5 py-2.5 bg-midnight text-white text-sm font-bold rounded-full shadow-md">All</button>
                         <button onclick="app.filterRewards('ai', this)" class="filter-btn px-5 py-2.5 bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 text-sm font-bold rounded-full border border-slate-200 transition-all hover:bg-slate-50">AI Tools</button>
                         <button onclick="app.filterRewards('education', this)" class="filter-btn px-5 py-2.5 bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 text-sm font-bold rounded-full border border-slate-200 transition-all hover:bg-slate-50">Education</button>
                         <button onclick="app.filterRewards('shopping', this)" class="filter-btn px-5 py-2.5 bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 text-sm font-bold rounded-full border border-slate-200 transition-all hover:bg-slate-50">Shopping</button>
                         <button onclick="app.filterRewards('entertainment', this)" class="filter-btn px-5 py-2.5 bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 text-sm font-bold rounded-full border border-slate-200 transition-all hover:bg-slate-50">Movies/OTT</button>
                         <button onclick="app.filterRewards('hotels', this)" class="filter-btn px-5 py-2.5 bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 text-sm font-bold rounded-full border border-slate-200 transition-all hover:bg-slate-50">Hotels</button>
                    </div>
                    
                    <div id="rewards-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        </div>
                </div>
            </div>

            <div id="view-schedule" class="hidden fade-in">
                 <div class="max-w-4xl mx-auto">
                    <form id="schedule-form" onsubmit="app.handleSchedule(event)" class="glow-card bg-white dark:bg-darkcard rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden flex flex-col lg:flex-row">
                        <div class="flex-1 p-8 space-y-8">
                            <h2 class="text-2xl font-bold text-midnight dark:text-white mb-6">Schedule Pickup</h2>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-3">1. Select Waste Type</label>
                                <div class="grid grid-cols-2 gap-3">
                                    <label class="cursor-pointer group">
                                        <input type="radio" name="wasteType" value="General" class="peer sr-only" checked onchange="app.handleTypeChange()">
                                        <div class="p-3 rounded-xl border-2 border-slate-100 dark:border-slate-700 peer-checked:border-green-500 peer-checked:bg-green-50 dark:peer-checked:bg-green-900/20 peer-checked:text-green-800 dark:peer-checked:text-white text-center transition-all">
                                            <i class="fas fa-trash-alt text-xl mb-1 text-slate-400 peer-checked:text-green-600"></i>
                                            <div class="text-xs font-bold">General</div>
                                            <div class="text-[10px] text-slate-400 mt-1">‚Çπ5/kg Base</div>
                                        </div>
                                    </label>
                                    <label class="cursor-pointer group">
                                        <input type="radio" name="wasteType" value="Plastic" class="peer sr-only" onchange="app.handleTypeChange()">
                                        <div class="p-3 rounded-xl border-2 border-slate-100 dark:border-slate-700 peer-checked:border-blue-500 peer-checked:bg-blue-50 dark:peer-checked:bg-blue-900/20 peer-checked:text-blue-800 dark:peer-checked:text-white text-center transition-all">
                                            <i class="fas fa-bottle-water text-xl mb-1 text-slate-400 peer-checked:text-blue-600"></i>
                                            <div class="text-xs font-bold">Plastic</div>
                                            <div class="text-[10px] text-slate-400 mt-1">‚Çπ12/kg Base</div>
                                        </div>
                                    </label>
                                    <label class="cursor-pointer group">
                                        <input type="radio" name="wasteType" value="E-Waste" class="peer sr-only" onchange="app.handleTypeChange()">
                                        <div class="p-3 rounded-xl border-2 border-slate-100 dark:border-slate-700 peer-checked:border-purple-500 peer-checked:bg-purple-50 dark:peer-checked:bg-purple-900/20 peer-checked:text-purple-800 dark:peer-checked:text-white text-center transition-all">
                                            <i class="fas fa-plug text-xl mb-1 text-slate-400 peer-checked:text-purple-600"></i>
                                            <div class="text-xs font-bold">E-Waste</div>
                                            <div class="text-[10px] text-slate-400 mt-1">‚Çπ40/kg Base</div>
                                        </div>
                                    </label>
                                    <label class="cursor-pointer group">
                                        <input type="radio" name="wasteType" value="Metal" class="peer sr-only" onchange="app.handleTypeChange()">
                                        <div class="p-3 rounded-xl border-2 border-slate-100 dark:border-slate-700 peer-checked:border-orange-500 peer-checked:bg-orange-50 dark:peer-checked:bg-orange-900/20 peer-checked:text-orange-800 dark:peer-checked:text-white text-center transition-all">
                                            <i class="fas fa-layer-group text-xl mb-1 text-slate-400 peer-checked:text-orange-600"></i>
                                            <div class="text-xs font-bold">Metal</div>
                                            <div class="text-[10px] text-slate-400 mt-1">‚Çπ25/kg Base</div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            <div id="condition-container">
                                <div class="flex justify-between items-center mb-3">
                                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300">2. Waste Condition</label>
                                </div>
                                <div class="flex gap-2 flex-wrap" id="condition-options"></div>
                                <p id="condition-note" class="text-[10px] text-slate-500 mt-2 italic">Select a condition to see final rate.</p>
                            </div>
                            <div class="bg-slate-50 dark:bg-slate-800/50 p-6 rounded-2xl border border-slate-100 dark:border-slate-700">
                                <div class="flex justify-between items-center mb-4">
                                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300">3. Estimated Weight</label>
                                    <span id="rate-badge" class="bg-brand-100 text-brand-700 dark:bg-brand-900 dark:text-brand-300 text-xs font-bold px-2 py-1 rounded">Rate: ‚Çπ5/kg</span>
                                </div>
                                <div class="relative mb-6">
                                    <input type="range" id="weightSlider" min="1" max="50" value="5" step="1" oninput="app.updatePrice()">
                                    <div class="flex justify-between text-xs text-slate-400 mt-2 font-medium"><span>1 kg</span><span>25 kg</span><span>50 kg</span></div>
                                </div>
                                <div class="flex items-center justify-between bg-white dark:bg-darkcard p-4 rounded-xl shadow-sm border border-slate-100 dark:border-slate-600">
                                    <div><div class="text-xs text-slate-500 dark:text-slate-400 font-medium uppercase">Weight</div><div class="text-2xl font-bold text-midnight dark:text-white"><span id="displayWeight">5</span> <span class="text-lg">kg</span></div></div>
                                    <div class="text-right"><div class="text-xs text-slate-500 dark:text-slate-400 font-medium uppercase">Est. Value</div><div class="text-2xl font-bold text-brand-600 dark:text-brand-400">‚Çπ<span id="displayPrice">25</span></div></div>
                                </div>
                            </div>
                        </div>

                        <div class="flex-1 p-8 bg-slate-50 dark:bg-slate-800/30 border-t lg:border-t-0 lg:border-l border-slate-100 dark:border-slate-700 space-y-6">
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Pickup Date</label><input type="date" id="input-date" required class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-darkcard text-sm dark:text-white outline-none"></div>
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Time Slot</label>
                                    <select id="input-slot" required class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-darkcard text-sm dark:text-white outline-none">
                                        <option value="09:00 - 11:00">09:00 AM - 11:00 AM</option>
                                        <option value="11:00 - 13:00">11:00 AM - 01:00 PM</option>
                                        <option value="14:00 - 16:00">02:00 PM - 04:00 PM</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Pickup Address</label>
                                <div class="relative mb-3">
                                    <div class="flex gap-2">
                                        <div class="relative flex-1">
                                            <i class="fas fa-search absolute left-4 top-3.5 text-slate-400 z-10"></i>
                                            <input type="text" id="input-address" required placeholder="Search area (India only)..." autocomplete="off" class="w-full pl-10 pr-10 py-3 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-darkcard text-sm dark:text-white outline-none">
                                            <button type="button" onclick="document.getElementById('input-address').value=''" class="absolute right-3 top-3 text-slate-400 hidden z-10" id="clear-search"><i class="fas fa-times"></i></button>
                                        </div>
                                        <button type="button" id="btn-locate" onclick="app.getCurrentLocation()" class="px-5 py-3 rounded-xl bg-brand-600 hover:bg-brand-700 text-white font-bold"><i class="fas fa-crosshairs"></i></button>
                                    </div>
                                    <div id="address-suggestions" class="hidden search-results"></div>
                                </div>
                                <select id="saved-addresses" onchange="app.fillAddress()" class="w-full mb-3 px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-600 bg-white/50 dark:bg-darkcard/50 text-xs text-slate-500 outline-none"><option value="">üìÇ Select a saved address...</option></select>
                                <label class="flex items-center gap-2 cursor-pointer mt-2"><input type="checkbox" id="save-address-chk" class="rounded text-brand-600"><span class="text-xs text-slate-500">Save address for future</span></label>
                            </div>
                            <div><label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Note to Driver</label><textarea id="input-note" rows="2" placeholder="Ex: Call when you arrive..." class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-darkcard text-sm dark:text-white outline-none"></textarea></div>
                            <div class="pt-4 mt-auto">
                                <div class="flex justify-between items-center mb-4 text-sm"><span class="text-slate-500">Total Estimated Value</span><span class="font-bold text-xl text-brand-600 dark:text-brand-400">‚Çπ<span id="finalPrice">25</span></span></div>
                                <button type="submit" id="submit-btn" class="w-full bg-midnight hover:bg-slate-800 dark:bg-brand-600 dark:hover:bg-brand-700 text-white px-8 py-4 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2">Confirm Pickup <i class="fas fa-check-circle"></i></button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <div id="view-report" class="hidden fade-in">
                <div class="max-w-2xl mx-auto">
                    <div class="bg-red-50 dark:bg-red-900/10 border border-red-100 dark:border-red-900/30 rounded-2xl p-6 mb-6 flex items-start gap-4">
                        <div class="text-3xl text-red-500">üì∏</div>
                        <div>
                            <h3 class="font-bold text-red-700 dark:text-red-400 text-lg">Spot a dump? Report it!</h3>
                            <p class="text-sm text-red-600/80 dark:text-red-400/80">Help us keep the city clean. Upload a photo and we'll send a team.</p>
                        </div>
                    </div>

                    <form id="report-form" onsubmit="app.handleReportSubmit(event)" class="bg-white dark:bg-darkcard p-8 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 space-y-6">
                       <div>
    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Area / Location <span class="text-red-500">*</span></label>
    <div class="relative mb-3">
        <div class="flex gap-2">
            <div class="relative flex-1">
                <i class="fas fa-search absolute left-4 top-3.5 text-slate-400 z-10"></i>
                <input type="text" id="report-area" required placeholder="Search area or click locate..." autocomplete="off" class="w-full pl-10 pr-10 py-3 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-darkcard text-sm dark:text-white focus:border-red-500 outline-none">
                <button type="button" onclick="document.getElementById('report-area').value=''" class="absolute right-3 top-3 text-slate-400 hidden z-10" id="clear-report-search"><i class="fas fa-times"></i></button>
            </div>
            <button type="button" id="btn-report-locate" onclick="app.getReportLocation()" class="px-5 py-3 rounded-xl bg-red-500 hover:bg-red-600 text-white font-bold transition-colors shadow-lg shadow-red-500/30">
                <i class="fas fa-crosshairs"></i>
            </button>
        </div>
        <div id="report-address-suggestions" class="hidden search-results"></div>
    </div>
</div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Reporter Name</label>
                                <input type="text" id="report-name" required class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-800 text-sm dark:text-white" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Phone Number <span class="text-red-500">*</span></label>
                                <input type="tel" id="report-phone" required placeholder="For verification" class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-darkcard text-sm dark:text-white focus:border-red-500 outline-none">
                            </div>
                        </div>

                        <div>
    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Type of Waste <span class="text-red-500">*</span></label>
    <select id="report-type" required class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-darkcard text-sm dark:text-white outline-none">
        <option value="">Select Waste Type...</option>
        <option value="General Garbage">General Garbage (Mixed)</option>
        <option value="Construction Debris">Construction Debris</option>
        <option value="Plastic/Recyclable">Plastic/Recyclable</option>
        <option value="Overflowing Bin">Overflowing Bin</option>
        <option value="Hazardous/Medical">Hazardous/Medical</option>
        <option value="Dead Animal">Dead Animal</option>
    </select>
</div>

<div>
    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Estimated Size</label>
    <div class="grid grid-cols-3 gap-3">
        <label class="cursor-pointer">
            <input type="radio" name="reportSize" value="Small" class="peer sr-only" checked>
            <div class="py-2 text-center rounded-lg border border-slate-200 dark:border-slate-600 text-slate-500 text-xs font-bold peer-checked:bg-slate-800 peer-checked:text-white dark:peer-checked:bg-white dark:peer-checked:text-slate-900 transition-all">Small</div>
        </label>
        <label class="cursor-pointer">
            <input type="radio" name="reportSize" value="Medium" class="peer sr-only">
            <div class="py-2 text-center rounded-lg border border-slate-200 dark:border-slate-600 text-slate-500 text-xs font-bold peer-checked:bg-slate-800 peer-checked:text-white dark:peer-checked:bg-white dark:peer-checked:text-slate-900 transition-all">Medium</div>
        </label>
        <label class="cursor-pointer">
            <input type="radio" name="reportSize" value="Large" class="peer sr-only">
            <div class="py-2 text-center rounded-lg border border-slate-200 dark:border-slate-600 text-slate-500 text-xs font-bold peer-checked:bg-slate-800 peer-checked:text-white dark:peer-checked:bg-white dark:peer-checked:text-slate-900 transition-all">Large</div>
        </label>
    </div>
</div>

<div>
    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Description / Landmarks</label>
    <textarea id="report-desc" rows="3" placeholder="Describe the location or contents (e.g., Near the old banyan tree)..." class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-darkcard text-sm dark:text-white outline-none"></textarea>
</div>

                        <button type="submit" id="report-btn" class="w-full py-4 bg-red-500 hover:bg-red-600 text-white font-bold rounded-xl shadow-lg shadow-red-500/30 transition-all flex items-center justify-center gap-2">
                            Submit Report <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                </div>
            </div>

            <div id="view-history" class="hidden fade-in">
                 <div class="bg-white dark:bg-darkcard rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden min-h-[400px]">
                    <div class="p-6 border-b border-slate-50 dark:border-slate-700 flex flex-col md:flex-row justify-between items-center gap-4">
                        <div><h2 class="text-xl font-bold text-midnight dark:text-white">Full Pickup History</h2><span class="text-xs text-slate-400" id="history-count">0 Records</span></div>
                        <div class="flex gap-3">
                            <select id="filter-type" onchange="app.applyHistoryFilters()" class="px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 text-xs font-bold text-slate-600 dark:text-slate-300 outline-none"><option value="All">All Types</option><option value="General">General</option><option value="Plastic">Plastic</option><option value="E-Waste">E-Waste</option><option value="Metal">Metal</option></select>
                            <select id="filter-weight" onchange="app.applyHistoryFilters()" class="px-3 py-2 rounded-lg bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-600 text-xs font-bold text-slate-600 dark:text-slate-300 outline-none"><option value="All">All Weights</option><option value="small">< 10 kg</option><option value="medium">10 - 30 kg</option><option value="large">> 30 kg</option></select>
                        </div>
                    </div>
                    <div id="history-list" class="p-2"></div>
                    <div id="history-empty" class="hidden flex flex-col items-center justify-center py-16 text-slate-400"><i class="fas fa-filter text-3xl opacity-50 mb-2"></i><p class="font-medium">No pickups found matching filters.</p></div>
                </div>
            </div>

            <div id="view-settings" class="hidden fade-in">
                 <div class="max-w-3xl mx-auto space-y-6">
                    <div class="bg-white dark:bg-darkcard p-8 rounded-3xl shadow-sm border border-slate-100 dark:border-slate-700">
                        <h3 class="text-xl font-bold text-midnight dark:text-white mb-6 flex items-center gap-2"><i class="fas fa-user-circle"></i> Profile Settings</h3>
                        <form onsubmit="app.saveProfile(event)" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-2">First Name</label><input type="text" id="settings-fname" class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-600 bg-transparent text-sm dark:text-white"></div>
                                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-2">Last Name</label><input type="text" id="settings-lname" class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-600 bg-transparent text-sm dark:text-white"></div>
                            </div>
                            <div><label class="block text-xs font-bold text-slate-500 uppercase mb-2">Email Address</label><input type="email" id="settings-email" disabled class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-900 text-slate-500 text-sm"></div>
                             <div><label class="block text-xs font-bold text-slate-500 uppercase mb-2">Phone Number</label><input type="tel" id="settings-phone" class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-600 bg-transparent text-sm dark:text-white" placeholder="+91 99999 99999"></div>
                             <div><label class="block text-xs font-bold text-slate-500 uppercase mb-2">Default Address</label><textarea id="settings-address" rows="2" class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-600 bg-transparent text-sm dark:text-white" placeholder="Enter your full address"></textarea></div>
                            
                            <div class="border-t border-slate-100 dark:border-slate-700 pt-6">
                                <h4 class="font-bold text-sm text-slate-700 dark:text-white mb-4">Notifications</h4>
                                <div class="flex items-center justify-between mb-3">
                                    <span class="text-sm text-slate-500">Email Notifications</span>
                                    <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="settings-notif-email" class="sr-only peer"><div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-brand-600"></div></label>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-slate-500">SMS Alerts</span>
                                    <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="settings-notif-sms" class="sr-only peer"><div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-brand-600"></div></label>
                                </div>
                            </div>
                            
                            <div class="text-right pt-2"><button type="submit" class="bg-brand-600 text-white px-8 py-3 rounded-xl text-sm font-bold hover:bg-brand-700 shadow-lg shadow-brand-500/30">Save Changes</button></div>
                        </form>
                    </div>
                    
                     <div class="bg-red-50 dark:bg-red-900/10 p-6 rounded-3xl border border-red-100 dark:border-red-900/30 flex items-center justify-between">
                        <div><h4 class="text-red-700 dark:text-red-400 font-bold">Danger Zone</h4><p class="text-xs text-red-600/70">Delete your account and all data.</p></div>
                        <button class="text-red-600 hover:bg-red-100 px-4 py-2 rounded-lg text-xs font-bold border border-red-200">Delete Account</button>
                    </div>
                </div>
            </div>
            
            <div id="view-analytics" class="hidden fade-in">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="md:col-span-1 bg-white dark:bg-darkcard p-5 rounded-3xl border border-slate-100 dark:border-slate-700 shadow-sm">
                         <div class="w-10 h-10 rounded-full bg-green-100 dark:bg-green-900/20 text-green-600 flex items-center justify-center text-lg mb-2"><i class="fas fa-cloud"></i></div>
                         <div class="text-2xl font-bold dark:text-white"><span id="ana-co2">0</span> <span class="text-sm font-normal text-slate-500">kg</span></div>
                         <div class="text-xs font-bold text-slate-400 uppercase tracking-wide">CO2 Avoided</div>
                    </div>
                     <div class="md:col-span-1 bg-white dark:bg-darkcard p-5 rounded-3xl border border-slate-100 dark:border-slate-700 shadow-sm">
                         <div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/20 text-blue-600 flex items-center justify-center text-lg mb-2"><i class="fas fa-tint"></i></div>
                         <div class="text-2xl font-bold dark:text-white"><span id="ana-water">0</span> <span class="text-sm font-normal text-slate-500">L</span></div>
                         <div class="text-xs font-bold text-slate-400 uppercase tracking-wide">Water Saved</div>
                    </div>
                     <div class="md:col-span-1 bg-white dark:bg-darkcard p-5 rounded-3xl border border-slate-100 dark:border-slate-700 shadow-sm">
                         <div class="w-10 h-10 rounded-full bg-orange-100 dark:bg-orange-900/20 text-orange-600 flex items-center justify-center text-lg mb-2"><i class="fas fa-bolt"></i></div>
                         <div class="text-2xl font-bold dark:text-white"><span id="ana-energy">0</span> <span class="text-sm font-normal text-slate-500">kWh</span></div>
                         <div class="text-xs font-bold text-slate-400 uppercase tracking-wide">Energy Saved</div>
                    </div>
                     <div class="md:col-span-1 bg-white dark:bg-darkcard p-5 rounded-3xl border border-slate-100 dark:border-slate-700 shadow-sm">
                         <div class="w-10 h-10 rounded-full bg-purple-100 dark:bg-purple-900/20 text-purple-600 flex items-center justify-center text-lg mb-2"><i class="fas fa-tree"></i></div>
                         <div class="text-2xl font-bold dark:text-white"><span id="ana-trees">0</span></div>
                         <div class="text-xs font-bold text-slate-400 uppercase tracking-wide">Trees Planted</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white dark:bg-darkcard p-6 rounded-3xl border border-slate-100 dark:border-slate-700 shadow-sm">
                        <h3 class="font-bold text-lg text-midnight dark:text-white mb-4">Waste Composition</h3>
                        <div class="relative h-64 w-full flex items-center justify-center"><canvas id="wasteDoughnut"></canvas></div>
                    </div>
                    <div class="bg-white dark:bg-darkcard p-6 rounded-3xl border border-slate-100 dark:border-slate-700 shadow-sm">
                        <h3 class="font-bold text-lg text-midnight dark:text-white mb-4">Monthly Trends</h3>
                        <div class="relative h-64 w-full"><canvas id="trendChart"></canvas></div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <div id="toast" class="fixed bottom-5 right-5 bg-midnight text-white px-6 py-3 rounded-lg shadow-xl transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center gap-3">
        <i class="fas fa-check-circle text-green-400"></i><span id="toast-msg">Operation successful</span>
    </div>

    <script type="module">
        import { auth, db } from './firebase-config.js';
        import { onAuthStateChanged, signOut, updatePassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { doc, getDoc, getDocs, updateDoc, collection, addDoc, query, where, onSnapshot, deleteDoc, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        window.app = {};
        let currentUser = null;
        let chartInstance = null;
        let donutInstance = null;
        let trendInstance = null;
        let activePickupCount = 0; 
        let pendingScheduleData = null; 
        let pendingCancellationId = null;
        let allPickupsData = []; 
        let userPoints = 0;
        let userCash = 0;
        let searchTimeout;
        let currentUserName = "Resident";
        
        let localNotifications = [];
        let previousPickupStates = {}; 
        
        let spentPoints = 0;
        let withdrawnCash = 0;
        let convertedCash = 0;

        const WASTE_CONFIG = {
            'General': { baseRate: 5, conditions: [{ name: 'Dry Waste', mult: 1.0 }, { name: 'Wet Waste', mult: 0.5 }, { name: 'Mixed', mult: 0.8 }] },
            'Plastic': { baseRate: 12, conditions: [{ name: 'Clean/Rinsed', mult: 1.0 }, { name: 'Dirty/Oily', mult: 0.5 }, { name: 'Mixed', mult: 0.75 }] },
            'E-Waste': { baseRate: 40, conditions: [{ name: 'Functional', mult: 1.25 }, { name: 'Broken/Scrap', mult: 1.0 }, { name: 'Batteries', mult: 0.5 }] },
            'Metal':   { baseRate: 25, conditions: [{ name: 'Scrap Metal', mult: 1.0 }, { name: 'Cans/Tins', mult: 1.0 }, { name: 'Rusted', mult: 0.8 }] }
        };

        const WASTE_ICONS = {
            'General': { icon: 'fa-trash-alt', color: 'text-green-500', bg: 'bg-green-50 dark:bg-green-900/20' },
            'Plastic': { icon: 'fa-bottle-water', color: 'text-blue-500', bg: 'bg-blue-50 dark:bg-blue-900/20' },
            'E-Waste': { icon: 'fa-plug', color: 'text-purple-500', bg: 'bg-purple-50 dark:bg-purple-900/20' },
            'Metal':   { icon: 'fa-layer-group', color: 'text-orange-500', bg: 'bg-orange-50 dark:bg-orange-900/20' }
        };

        const LEVELS = [
            { name: "Seed üå±", max: 1000 }, { name: "Sapling üåø", max: 5000 }, { name: "Tree üå≥", max: 20000 }, { name: "Forest üèûÔ∏è", max: 100000 }
        ];

        // --- UPDATED REWARDS DATA (Replaced Oyo, fixed icons) ---
        const REWARDS_DATA = [
            { id: 1, type: 'fuel', cat: 'fuel', title: 'Bharat Petrol Pass', pts: 50000, icon: 'fas fa-gas-pump', color: 'orange' },
            { id: 2, type: 'ott', cat: 'entertainment', title: 'Netflix Mobile Plan', pts: 15000, icon: 'fab fa-netflix', color: 'red' },
            { id: 3, type: 'edu', cat: 'education', title: 'Udemy Course Coupon', pts: 25000, icon: 'fas fa-graduation-cap', color: 'purple' },
            { id: 4, type: 'food', cat: 'food', title: 'Swiggy Money ‚Çπ500', pts: 5000, icon: 'fas fa-utensils', color: 'orange' },
            { id: 5, type: 'shop', cat: 'shopping', title: 'Flipkart Gift Card', pts: 20000, icon: 'fas fa-shopping-bag', color: 'blue' },
            { id: 6, type: 'ai', cat: 'ai', title: 'ChatGPT Plus (1 Mo)', pts: 45000, icon: 'fas fa-robot', color: 'teal' },
            { id: 7, type: 'shop', cat: 'shopping', title: 'Amazon Gift Card', pts: 10000, icon: 'fab fa-amazon', color: 'yellow' },
            { id: 8, type: 'movie', cat: 'entertainment', title: 'PVR Ticket Voucher', pts: 6000, icon: 'fas fa-film', color: 'indigo' },
            { id: 9, type: 'ai', cat: 'ai', title: 'Midjourney Credits', pts: 30000, icon: 'fas fa-paint-brush', color: 'pink' },
            { id: 10, type: 'edu', cat: 'education', title: 'Coursera Plus (1 Mo)', pts: 40000, icon: 'fas fa-book-open', color: 'blue' }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('eco_theme') === 'dark') document.documentElement.classList.add('dark');
            setupClock(); app.handleTypeChange(); app.loadSavedAddresses();
            document.getElementById('input-date').min = new Date().toISOString().split('T')[0];
            document.getElementById('view-dashboard').classList.remove('hidden');
            setupSearchListeners();
            setupConverterListener();
            app.renderRewards(); 
            
            spentPoints = parseInt(localStorage.getItem('eco_spentPoints') || 0);
            withdrawnCash = parseFloat(localStorage.getItem('eco_withdrawnCash') || 0);
            convertedCash = parseFloat(localStorage.getItem('eco_convertedCash') || 0);
        });

        app.renderRewards = () => {
            const grid = document.getElementById('rewards-grid');
            grid.innerHTML = REWARDS_DATA.map(r => `
                <div class="reward-card category-${r.cat} bg-white dark:bg-darkcard p-6 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm hover:shadow-xl transition-all group relative overflow-hidden fade-in">
                    <div class="flex items-start justify-between mb-4">
                        <div class="h-14 w-14 bg-${r.color}-100 rounded-2xl flex items-center justify-center text-${r.color}-600 text-3xl"><i class="${r.icon}"></i></div>
                        <span class="bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 text-xs font-bold px-2 py-1 rounded-lg">${r.pts/1000}k Pts</span>
                    </div>
                    <h4 class="font-bold text-lg text-midnight dark:text-white mb-1">${r.title}</h4>
                    <button onclick="app.redeemReward('${r.title}', ${r.pts})" class="w-full py-3 bg-midnight hover:bg-slate-800 text-white text-sm font-bold rounded-xl mt-4">Redeem Now</button>
                </div>
            `).join('');
        };

        app.toggleNotifications = () => {
            const menu = document.getElementById('notif-menu');
            const overlay = document.getElementById('notif-overlay');
            if (menu.classList.contains('hidden')) {
                menu.classList.remove('hidden'); overlay.classList.remove('hidden');
                document.getElementById('notif-badge').classList.add('hidden');
            } else {
                menu.classList.add('hidden'); overlay.classList.add('hidden');
            }
        };

        app.addNotification = (msg, type='info') => {
            const list = document.getElementById('notif-list');
            if(list.children.length === 1 && list.children[0].innerText === "No new notifications") list.innerHTML = '';
            const div = document.createElement('div');
            div.className = "p-3 border-b border-slate-50 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors cursor-pointer";
            const icon = type === 'alert' ? 'fa-exclamation-circle text-red-500' : 'fa-info-circle text-brand-500';
            div.innerHTML = `<div class="flex gap-3"><i class="fas ${icon} mt-1"></i><div><p class="text-xs font-bold text-slate-700 dark:text-slate-200">${msg}</p><p class="text-[10px] text-slate-400 mt-1">${new Date().toLocaleTimeString()}</p></div></div>`;
            list.prepend(div);
            document.getElementById('notif-badge').classList.remove('hidden');
        };

        app.clearNotifications = () => {
            document.getElementById('notif-list').innerHTML = '<div class="p-6 text-center text-slate-400 text-xs">No new notifications</div>';
            document.getElementById('notif-badge').classList.add('hidden');
        };

        function setupSearchListeners() {
            const input = document.getElementById('input-address');
            const results = document.getElementById('address-suggestions');
            input.addEventListener('input', (e) => {
                const query = e.target.value;
                if(query.length > 0) document.getElementById('clear-search').classList.remove('hidden');
                else document.getElementById('clear-search').classList.add('hidden');
                clearTimeout(searchTimeout);
                if(query.length < 3) { results.classList.add('hidden'); return; }
                searchTimeout = setTimeout(async () => {
                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&countrycodes=in`);
                        const data = await response.json();
                        results.innerHTML = '';
                        if(data.length > 0) {
                            data.forEach(place => {
                                const item = document.createElement('div');
                                item.className = 'search-item';
                                item.innerHTML = `<i class="fas fa-map-marker-alt text-brand-500 mr-2"></i> ${place.display_name}`;
                                item.onclick = () => { input.value = place.display_name; results.classList.add('hidden'); };
                                results.appendChild(item);
                            });
                            results.classList.remove('hidden');
                        }
                    } catch(e) {}
                }, 300);
            });
            document.addEventListener('click', (e) => { if(!input.contains(e.target) && !results.contains(e.target)) results.classList.add('hidden'); });
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadUserData(user.uid);
                initListeners(user.uid);
            } else {
                window.location.href = 'auth.html';
            }
        });

        function initListeners(uid) {
            const q = query(collection(db, "pickups"), where("userId", "==", uid));
            onSnapshot(q, (snap) => {
                const pickups = [];
                activePickupCount = 0; 
                snap.forEach(d => {
                    const data = {id: d.id, ...d.data()};
                    pickups.push(data);
                    
                    if (data.status === 'Pending' || data.status === 'Assigned' || data.status === 'Arrived') activePickupCount++;
                    
                    if (previousPickupStates[data.id]) {
                         const prev = previousPickupStates[data.id];
                         if (prev.status !== data.status && data.status !== 'Pending') {
                             app.addNotification(`Order #${data.id.substring(0,4)} update: ${data.status}`, 'info');
                         }
                         if (data.driverNote && data.driverNote !== prev.driverNote) {
                             app.addNotification(`Driver Note: ${data.driverNote}`, 'alert');
                         }
                    }
                    previousPickupStates[data.id] = { status: data.status, driverNote: data.driverNote };
                });
                
                pickups.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                allPickupsData = pickups; 
                updateUI(pickups);
                renderAnalytics(pickups);
                app.applyHistoryFilters();
                updateGreenScore(pickups);
                
                const latestActive = pickups.find(p => ['Pending', 'Assigned', 'Arrived', 'Completed'].includes(p.status));
                updateStatusTracker(latestActive);
            });
        }

        function updateStatusTracker(pickup) {
            const tracker = document.getElementById('active-status-tracker');
            const steps = ['pending', 'assigned', 'arrived', 'completed'];
            if (!pickup || pickup.status === 'Cancelled') { tracker.classList.add('hidden'); return; }
            tracker.classList.remove('hidden');
            document.getElementById('tracker-id').innerText = '#' + pickup.id.substring(0, 8);
            
            const msgBox = document.getElementById('tracker-msg');
            if(pickup.driverNote) { msgBox.classList.remove('hidden'); document.getElementById('tracker-msg-text').innerText = pickup.driverNote; } 
            else { msgBox.classList.add('hidden'); }

            let currentIndex = steps.indexOf(pickup.status.toLowerCase());
            if(currentIndex === -1) currentIndex = 0; 
             // --- NEW: Report Location Logic ---

// 1. Auto-Detect Location for Report Dump
app.getReportLocation = () => {
    if (!navigator.geolocation) return showToast("Geolocation not supported", "error");
    
    const btn = document.getElementById('btn-report-locate'); 
    const originalHtml = btn.innerHTML; 
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; // Loading state
    
    navigator.geolocation.getCurrentPosition(async (p) => {
        try {
            // Using OpenStreetMap Nominatim API for reverse geocoding
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${p.coords.latitude}&lon=${p.coords.longitude}`);
            const data = await response.json();
            
            // Fill the input with the detected address
            document.getElementById('report-area').value = data.display_name || `${p.coords.latitude}, ${p.coords.longitude}`;
            showToast("Location detected successfully!");
        } catch (e) { 
            console.error(e);
            // Fallback to coordinates if API fails
            document.getElementById('report-area').value = `${p.coords.latitude}, ${p.coords.longitude}`;
            showToast("Address lookup failed, using coordinates.", "warning");
        } finally { 
            btn.innerHTML = originalHtml; 
        }
    }, (err) => { 
        console.warn(err);
        showToast("Please allow location access.", "error"); 
        btn.innerHTML = originalHtml; 
    }, { enableHighAccuracy: true }); // Request high accuracy
};

// 2. Enable Address Search Suggestions for Report Field
function setupReportSearchListener() {
    const input = document.getElementById('report-area');
    const results = document.getElementById('report-address-suggestions');
    const clearBtn = document.getElementById('clear-report-search');
    let reportSearchTimeout;

    if(!input) return;

    input.addEventListener('input', (e) => {
        const query = e.target.value;
        if(query.length > 0) clearBtn.classList.remove('hidden');
        else clearBtn.classList.add('hidden');
        
        clearTimeout(reportSearchTimeout);
        if(query.length < 3) { results.classList.add('hidden'); return; }
        
        reportSearchTimeout = setTimeout(async () => {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&countrycodes=in`);
                const data = await response.json();
                results.innerHTML = '';
                
                if(data.length > 0) {
                    data.forEach(place => {
                        const item = document.createElement('div');
                        item.className = 'search-item';
                        item.innerHTML = `<i class="fas fa-map-marker-alt text-red-500 mr-2"></i> ${place.display_name}`;
                        item.onclick = () => { 
                            input.value = place.display_name; 
                            results.classList.add('hidden'); 
                        };
                        results.appendChild(item);
                    });
                    results.classList.remove('hidden');
                }
            } catch(e) {}
        }, 300);
    });

    // Hide dropdown when clicking outside
    document.addEventListener('click', (e) => { 
        if(!input.contains(e.target) && !results.contains(e.target)) {
            results.classList.add('hidden'); 
        }
    });
}
            document.getElementById('tracker-line').style.width = ((currentIndex / (steps.length - 1)) * 100) + "%";
            steps.forEach((step, index) => {
                const el = document.getElementById(`step-${step}`);
                el.classList.remove('step-active', 'step-completed');
                const dot = el.querySelector('.step-dot');
                const label = el.querySelector('span');
                
                if (index < currentIndex) {
                    el.classList.add('step-completed');
                    dot.classList.remove('bg-slate-200', 'dark:bg-slate-700', 'text-slate-400');
                    dot.classList.add('bg-green-600', 'text-white', 'border-green-600');
                    label.classList.add('text-green-600');
                } else if (index === currentIndex) {
                    el.classList.add('step-active');
                    dot.classList.remove('bg-slate-200', 'dark:bg-slate-700', 'text-slate-400');
                    dot.classList.add('bg-green-500', 'text-white', 'border-green-500');
                    label.classList.add('text-green-500', 'dark:text-white');
                } else {
                    dot.classList.add('bg-slate-200', 'dark:bg-slate-700', 'text-slate-400');
                    dot.classList.remove('bg-green-600', 'bg-green-500', 'text-white', 'border-green-600', 'border-green-500');
                    label.classList.remove('text-green-600', 'text-green-500', 'dark:text-white');
                }
            });
        }

        function updateUI(pickups) {
            const count = pickups.length;
            const completed = pickups.filter(p => p.status === 'Completed');
            
            const earnedPoints = completed.reduce((sum, p) => sum + (p.pointsEarned || 0), 0);
            const earnedCash = completed.reduce((sum, p) => sum + (p.price || 0), 0);

            userPoints = earnedPoints - spentPoints;
            userCash = earnedCash + convertedCash - withdrawnCash;

            ['stat-points', 'header-points', 'rewards-points'].forEach(id => { const el = document.getElementById(id); if(el) el.innerText = userPoints; });
            ['stat-cash', 'rewards-cash'].forEach(id => { const el = document.getElementById(id); if(el) el.innerText = userCash.toFixed(0); });
            document.getElementById('stat-pickups').innerText = completed.length; 

            updateLevelProgress();
            
            const dashList = document.getElementById('dashboard-activity-list');
            if(dashList) {
                if(count === 0) dashList.innerHTML = '<div class="text-center text-slate-400 py-4 text-xs">No recent activity.</div>';
                else dashList.innerHTML = pickups.slice(0, 3).map(p => createCard(p, false)).join(''); 
            }
        }

        function updateGreenScore(pickups) {
            if (pickups.length === 0) { document.getElementById('green-score').innerText = "50"; return; }
            let baseScore = 100;
            let deduction = 0;
            let addition = 0;
            pickups.forEach(p => {
                if (p.status === 'Completed') addition += 5;
                if (p.status === 'Cancelled' || p.status === 'cancelled') deduction += 20;
            });
            let score = baseScore - deduction + addition;
            score = Math.max(0, Math.min(100, score));
            const el = document.getElementById('green-score');
            el.innerText = score;
            if(score > 80) el.className = "text-xl font-black text-emerald-600 dark:text-emerald-400 leading-none";
            else if(score > 50) el.className = "text-xl font-black text-yellow-600 dark:text-yellow-400 leading-none";
            else el.className = "text-xl font-black text-red-600 dark:text-red-400 leading-none";
        }

        app.handleReportSubmit = async (e) => {
    e.preventDefault(); 
    const btn = document.getElementById('report-btn');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...'; 
    btn.disabled = true;

    // Get values from new fields
    const area = document.getElementById('report-area').value;
    const phone = document.getElementById('report-phone').value;
    const wasteType = document.getElementById('report-type').value;
    const description = document.getElementById('report-desc').value;
    const size = document.querySelector('input[name="reportSize"]:checked').value;

    setTimeout(async () => {
        try {
            // Save text data instead of image
            await addDoc(collection(db, "reports"), {
                userId: currentUser.uid,
                reporterName: document.getElementById('report-name').value,
                area: area,
                phone: phone,
                wasteType: wasteType, // New field
                description: description, // New field
                estimatedSize: size, // New field
                status: 'Reported',
                timestamp: new Date()
            });
            
            document.getElementById('report-form').reset();
            
            // Show success modal
            document.getElementById('report-success-modal').classList.remove('hidden');
            document.getElementById('report-success-modal').classList.add('flex');
            
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#ef4444', '#f97316', '#fbbf24'] });
            
        } catch (error) { 
            console.error("Report Error:", error);
            showToast("Failed to submit report. Try again.", "error"); 
        } finally { 
            btn.innerHTML = originalText; 
            btn.disabled = false; 
        }
    }, 1000); 
};

    

        app.closeReportModal = () => { document.getElementById('report-success-modal').classList.add('hidden'); document.getElementById('report-success-modal').classList.remove('flex'); app.switchView('dashboard'); };

        app.loadLeaderboard = async () => {
            const tbody = document.getElementById('leaderboard-body');
            tbody.innerHTML = '<tr><td colspan="4" class="p-6 text-center text-slate-400">Loading champions...</td></tr>';
            try {
                const q = query(collection(db, "users"), limit(10)); 
                const snapshot = await getDocs(q);
                let users = [];
                snapshot.forEach(doc => {
                    const d = doc.data();
                    users.push({ 
                        name: d.firstName || 'Anonymous', 
                        points: d.totalPoints || Math.floor(Math.random() * 2000), 
                        pickups: d.totalPickups || Math.floor(Math.random() * 20),
                        id: doc.id 
                    });
                });
                const myEntryIndex = users.findIndex(u => u.id === currentUser.uid);
                const myCompleted = document.getElementById('stat-pickups').innerText;
                const myLiveEntry = { 
                    name: currentUserName, 
                    points: userPoints, 
                    pickups: myCompleted, 
                    id: currentUser.uid 
                };
                if(myEntryIndex > -1) { users[myEntryIndex] = myLiveEntry; } 
                else { users.push(myLiveEntry); }

                if(users.length === 1 && users[0].id === currentUser.uid) {
                     users.push(
                        { name: 'Sarah J.', points: 2450, pickups: 42, id: 'mock1' },
                        { name: 'Rajesh K.', points: 2100, pickups: 38, id: 'mock2' },
                        { name: 'Amit Verma', points: 1850, pickups: 29, id: 'mock3' }
                     );
                }
                users.sort((a,b) => b.points - a.points);
                renderLeaderboardTable(users, tbody);
            } catch (e) { console.error(e); }
        };

        function renderLeaderboardTable(users, tbody) {
             tbody.innerHTML = users.map((u, index) => {
                let badge = '';
                if(index === 0) badge = 'ü•á'; else if(index === 1) badge = 'ü•à'; else if(index === 2) badge = 'ü•â';
                const isMe = u.id === currentUser.uid;
                const rowClass = isMe ? "bg-green-50 dark:bg-green-900/40 border-l-4 border-brand-500 shadow-sm" : "hover:bg-slate-50 dark:hover:bg-slate-800 border-l-4 border-transparent";
                const nameDisplay = isMe ? `<span class="font-bold text-brand-700 dark:text-brand-400">${u.name} <span class="ml-2 text-[10px] bg-brand-500 text-white px-2 py-0.5 rounded-full uppercase">You</span></span>` : u.name;
                return `<tr class="border-b border-slate-50 dark:border-slate-800 transition-all ${rowClass}">
                    <td class="p-4 font-bold text-slate-600 dark:text-slate-300">${badge} #${index + 1}</td>
                    <td class="p-4 font-medium dark:text-white">${nameDisplay}</td>
                    <td class="p-4 text-right font-mono text-slate-500">${u.pickups}</td>
                    <td class="p-4 text-right font-bold text-brand-600 dark:text-brand-400">${u.points}</td>
                </tr>`;
            }).join('');
        }

        function updateLevelProgress() {
            let currentLevel = LEVELS[0];
            let nextLevel = LEVELS[1];
            for(let i=0; i < LEVELS.length; i++) {
                if(userPoints < LEVELS[i].max) {
                    currentLevel = LEVELS[i > 0 ? i-1 : 0];
                    nextLevel = i < LEVELS.length - 1 ? LEVELS[i+1] : null;
                    break;
                }
            }
            document.getElementById('level-name').innerText = currentLevel.name;
            if(nextLevel) {
                const percent = Math.min(100, (userPoints / nextLevel.max) * 100);
                document.getElementById('level-bar').style.width = percent + "%";
                document.getElementById('level-next').innerText = `Next: ${nextLevel.name} (${nextLevel.max} Pts)`;
            } else {
                document.getElementById('level-bar').style.width = "100%";
                document.getElementById('level-next').innerText = "Max Level Reached!";
            }
        }

        function setupConverterListener() {
            document.getElementById('convert-input').addEventListener('input', (e) => {
                const pts = parseInt(e.target.value) || 0;
                document.getElementById('convert-preview').innerText = (pts / 100).toFixed(2);
            });
        }

        app.convertPoints = async () => {
            const input = document.getElementById('convert-input');
            const ptsToConvert = parseInt(input.value);
            if(!ptsToConvert || ptsToConvert <= 0) return showToast("Enter valid points", "error");
            if(ptsToConvert > userPoints) return showToast("Insufficient EcoPoints", "error");
            const cashValue = ptsToConvert / 100;
            if(confirm(`Convert ${ptsToConvert} Points into ‚Çπ${cashValue}?`)) {
                spentPoints += ptsToConvert;
                convertedCash += cashValue;
                localStorage.setItem('eco_spentPoints', spentPoints);
                localStorage.setItem('eco_convertedCash', convertedCash);
                updateUI(allPickupsData);
                showToast(`Converted! Added ‚Çπ${cashValue} to wallet.`);
                input.value = '';
                document.getElementById('convert-preview').innerText = '0';
            }
        };

        app.withdrawUPI = () => {
            const upi = document.getElementById('upi-id').value;
            if(!upi || !upi.includes('@')) return showToast("Invalid UPI ID", "error");
            if(userCash < 100) return showToast("Min withdrawal ‚Çπ100", "error");
            if(confirm(`Withdraw ‚Çπ${userCash} to ${upi}?`)) {
                withdrawnCash += userCash; 
                localStorage.setItem('eco_withdrawnCash', withdrawnCash);
                updateUI(allPickupsData);
                showToast(`Withdrawal request sent!`);
            }
        };

        function createCard(p, isHistoryView = true) {
            const showOtp = (p.status === 'Pending' || p.status === 'Assigned');
            const style = WASTE_ICONS[p.type] || WASTE_ICONS['General'];
            const otpHtml = showOtp ? `<div class="mt-4 bg-white dark:bg-slate-700 border-2 border-dashed border-brand-300 dark:border-slate-500 rounded-xl p-4 text-center relative overflow-hidden group"><div class="absolute top-0 left-0 w-full h-1 bg-brand-500"></div><div class="flex justify-between items-center mb-1"><p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Secure Pickup Code</p><span class="text-[10px] bg-brand-100 text-brand-700 dark:bg-brand-900 dark:text-brand-300 px-2 py-0.5 rounded font-bold">LIVE</span></div><div class="text-3xl font-mono font-black text-midnight dark:text-white tracking-[0.3em] group-hover:scale-110 transition-transform select-all">${p.otp || '....'}</div></div>` : '';
            let actionBtns = '';
            if (isHistoryView) {
                const cancelBtn = (p.status === 'Pending' || p.status === 'Assigned') ? `<button onclick="app.openCancelModal('${p.id}')" class="flex-1 py-2 text-xs font-bold text-red-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/10 rounded-lg transition-colors border border-dashed border-red-200 dark:border-red-900/30"><i class="fas fa-times-circle mr-1"></i> Cancel</button>` : '';
                actionBtns = `<div class="flex gap-2 mt-3">${cancelBtn}<button onclick='app.openDetailsModal(${JSON.stringify(p).replace(/'/g, "'")})' class="flex-1 py-2 text-xs font-bold text-slate-500 hover:text-brand-600 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors border border-slate-200 dark:border-slate-700"><i class="fas fa-eye mr-1"></i> View Details</button></div>`;
            }
            let badgeClass = 'text-brand-600 bg-brand-50 dark:bg-slate-700';
            if(p.status === 'Completed') badgeClass = 'text-slate-500 bg-slate-100 dark:bg-slate-800';
            if(p.status === 'Cancelled') badgeClass = 'text-red-500 bg-red-50 dark:bg-red-900/20';
            const padd = isHistoryView ? 'p-4' : 'p-3';
            return `<div class="flex flex-col ${padd} mb-3 bg-slate-50 dark:bg-slate-800 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm transition-all hover:shadow-md"><div class="flex items-center justify-between"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full ${style.bg} ${style.color} border border-slate-200 dark:border-slate-600 flex items-center justify-center text-lg"><i class="fas ${style.icon}"></i></div><div><div class="font-bold text-midnight dark:text-white text-sm">${p.type} <span class="text-xs font-normal text-slate-400">(${p.weight})</span></div><div class="text-[10px] text-slate-500 dark:text-slate-400">${p.date} ‚Ä¢ <span class="font-mono">‚Çπ${p.price}</span></div></div></div><div class="text-right"><span class="block text-[10px] font-bold ${badgeClass} px-2 py-0.5 rounded mb-1">${p.status}</span></div></div>${otpHtml}${actionBtns}</div>`;
        }

        app.handleTypeChange = () => {
            const selectedType = document.querySelector('input[name="wasteType"]:checked').value;
            const config = WASTE_CONFIG[selectedType];
            document.getElementById('rate-badge').innerText = `Base Rate: ‚Çπ${config.baseRate}/kg`;
            const conditionContainer = document.getElementById('condition-options');
            conditionContainer.innerHTML = config.conditions.map((c, i) => `
                <label class="cursor-pointer">
                    <input type="radio" name="wasteCondition" value="${c.mult}" data-name="${c.name}" class="peer sr-only" ${i===0?'checked':''} onchange="app.updatePrice()">
                    <span class="px-3 py-1.5 rounded-lg border border-slate-200 dark:border-slate-600 text-xs font-medium text-slate-500 peer-checked:bg-slate-200 dark:peer-checked:bg-slate-600 peer-checked:text-slate-900 dark:peer-checked:text-white transition-colors hover:bg-slate-100 dark:hover:bg-slate-800">${c.name}</span>
                </label>`).join('');
            app.updatePrice();
        };

        app.updatePrice = () => {
            const weight = parseInt(document.getElementById('weightSlider').value);
            const selectedType = document.querySelector('input[name="wasteType"]:checked').value;
            const conditionEl = document.querySelector('input[name="wasteCondition"]:checked');
            const baseRate = WASTE_CONFIG[selectedType].baseRate;
            const multiplier = parseFloat(conditionEl.value);
            const totalPrice = Math.round(weight * baseRate * multiplier);
            document.getElementById('displayWeight').innerText = weight;
            document.getElementById('displayPrice').innerText = totalPrice;
            document.getElementById('finalPrice').innerText = totalPrice;
            document.getElementById('condition-note').innerText = `Selected: ${conditionEl.getAttribute('data-name')} (${multiplier * 100}% of base rate)`;
        };

        app.handleSchedule = async (e) => {
            e.preventDefault();
            const address = document.getElementById('input-address').value;
            const wasteType = document.querySelector('input[name="wasteType"]:checked').value;
            const conditionEl = document.querySelector('input[name="wasteCondition"]:checked');
            const weight = parseInt(document.getElementById('weightSlider').value);
            const date = document.getElementById('input-date').value;
            const slot = document.getElementById('input-slot').value;
            const note = document.getElementById('input-note').value;
            
            if(!address || !date || !slot) { showToast("Please fill all required fields", "error"); return; }
            if(document.getElementById('save-address-chk').checked) app.saveAddressLocally(address);

            if (activePickupCount > 0) { 
                document.getElementById('active-order-modal').classList.remove('hidden'); 
                document.getElementById('active-order-modal').classList.add('flex'); 
                return; 
            }

            pendingScheduleData = {
                userId: currentUser.uid, 
                userEmail: currentUser.email,
                userName: currentUserName, 
                type: wasteType, condition: conditionEl.getAttribute('data-name'),
                weight: weight + ' kg', weightValue: weight,
                price: parseInt(document.getElementById('finalPrice').innerText),
                pointsEarned: weight * 5,
                address: address, pickupDate: date, pickupSlot: slot, driverNote: note,
                date: new Date().toLocaleDateString('en-IN'), status: 'Pending', 
                otp: Math.floor(1000 + Math.random() * 9000), createdAt: new Date()
            };

            submitScheduleData();
        };

        app.closeSuccessModal = () => { document.getElementById('success-modal').classList.add('hidden'); document.getElementById('success-modal').classList.remove('flex'); app.switchView('history'); };

        async function submitScheduleData() {
            if (!pendingScheduleData) return;
            const btn = document.getElementById('submit-btn'); btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Scheduling...'; btn.disabled = true;
            try {
                await addDoc(collection(db, "pickups"), pendingScheduleData);
                document.getElementById('success-points').innerText = `${pendingScheduleData.pointsEarned} Pts`;
                document.getElementById('success-modal').classList.remove('hidden'); document.getElementById('success-modal').classList.add('flex');
                confetti({ particleCount: 150, spread: 60 });
                document.getElementById('schedule-form').reset(); app.handleTypeChange();
            } catch (err) { showToast("Failed to schedule.", 'error'); } 
            finally { btn.innerHTML = 'Confirm Pickup <i class="fas fa-check-circle"></i>'; btn.disabled = false; pendingScheduleData = null; }
        }

        app.loadSavedAddresses = () => {
            const addresses = JSON.parse(localStorage.getItem('savedAddresses') || '[]');
            const select = document.getElementById('saved-addresses');
            if(addresses.length === 0) { select.classList.add('hidden'); return; }
            select.classList.remove('hidden');
            select.innerHTML = `<option value="">Select a saved address...</option>` + addresses.map(a => `<option value="${a}">${a.substring(0, 40)}...</option>`).join('');
        };
        app.saveAddressLocally = (addr) => {
            let addresses = JSON.parse(localStorage.getItem('savedAddresses') || '[]');
            if(!addresses.includes(addr)) { addresses.push(addr); localStorage.setItem('savedAddresses', JSON.stringify(addresses)); app.loadSavedAddresses(); }
        };
        app.fillAddress = () => { const val = document.getElementById('saved-addresses').value; if(val) document.getElementById('input-address').value = val; };
        
       app.getCurrentLocation = () => {
    if (!navigator.geolocation) return showToast("Geolocation not supported", "error");
    const btn = document.getElementById('btn-locate'); 
    const originalHtml = btn.innerHTML; 
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    // Added enableHighAccuracy option for better precision
    navigator.geolocation.getCurrentPosition(async (p) => {
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${p.coords.latitude}&lon=${p.coords.longitude}`);
            const data = await response.json();
            document.getElementById('input-address').value = data.display_name || `${p.coords.latitude}, ${p.coords.longitude}`;
            showToast("Location found!");
        } catch (e) { 
            document.getElementById('input-address').value = `${p.coords.latitude}, ${p.coords.longitude}`; 
        } finally { 
            btn.innerHTML = originalHtml; 
        }
    }, () => { 
        showToast("Location permission denied", "error"); 
        btn.innerHTML = originalHtml; 
    }, { enableHighAccuracy: true }); // <--- Crucial for better results
};

        app.applyHistoryFilters = () => {
            const typeFilter = document.getElementById('filter-type').value;
            const weightFilter = document.getElementById('filter-weight').value;
            let filtered = allPickupsData.filter(p => {
                let matchesType = (typeFilter === 'All') || (p.type === typeFilter);
                let matchesWeight = true; const w = p.weightValue || parseInt(p.weight);
                if(weightFilter === 'small') matchesWeight = w < 10;
                else if(weightFilter === 'medium') matchesWeight = w >= 10 && w <= 30;
                else if(weightFilter === 'large') matchesWeight = w > 30;
                return matchesType && matchesWeight;
            });
            const list = document.getElementById('history-list'); const empty = document.getElementById('history-empty');
            document.getElementById('history-count').innerText = filtered.length + " Records";
            if(filtered.length === 0) { list.innerHTML = ''; empty.classList.remove('hidden'); empty.classList.add('flex'); } 
            else { empty.classList.add('hidden'); empty.classList.remove('flex'); list.innerHTML = filtered.map(p => createCard(p, true)).join(''); }
        };

        app.openDetailsModal = (p) => {
            const style = WASTE_ICONS[p.type] || WASTE_ICONS['General'];
            document.getElementById('detail-id').innerText = `ID: #${p.id.substring(0,8)}`;
            const iconDiv = document.getElementById('detail-icon'); iconDiv.className = `w-12 h-12 rounded-full flex items-center justify-center text-2xl ${style.bg} ${style.color}`; iconDiv.innerHTML = `<i class="fas ${style.icon}"></i>`;
            document.getElementById('detail-type').innerText = p.type; document.getElementById('detail-condition').innerText = `Condition: ${p.condition || 'N/A'}`;
            document.getElementById('detail-weight').innerText = p.weight; document.getElementById('detail-price').innerText = `‚Çπ${p.price}`;
            document.getElementById('detail-address').innerText = p.address;
            document.getElementById('details-modal').classList.remove('hidden'); document.getElementById('details-modal').classList.add('flex');
        };

        app.cancelDuplicateSchedule = () => { document.getElementById('active-order-modal').classList.add('hidden'); document.getElementById('active-order-modal').classList.remove('flex'); pendingScheduleData = null; };
        app.proceedDuplicateSchedule = () => { document.getElementById('active-order-modal').classList.add('hidden'); document.getElementById('active-order-modal').classList.remove('flex'); submitScheduleData(); };
        app.openCancelModal = (id) => { pendingCancellationId = id; document.getElementById('cancel-modal').classList.remove('hidden'); document.getElementById('cancel-modal').classList.add('flex'); };
        app.submitCancellation = async (e) => {
            if(e) e.preventDefault(); if(!pendingCancellationId) return;
            try { await updateDoc(doc(db, "pickups", pendingCancellationId), { status: 'Cancelled', cancelledAt: new Date(), cancellationReason: document.querySelector('input[name="cancelReason"]:checked').value });
            showToast("Order Cancelled"); document.getElementById('cancel-modal').classList.add('hidden'); document.getElementById('cancel-modal').classList.remove('flex'); } catch(e) { showToast("Error cancelling", "error"); }
        };

        function renderAnalytics(pickups) {
            let totalWeight = 0; pickups.forEach(p => totalWeight += (p.weightValue ? p.weightValue : (parseInt(p.weight) || 0)));
            const co2 = (totalWeight * 1.5).toFixed(1);
            document.getElementById('ana-co2').innerText = co2; 
            document.getElementById('dash-co2-preview').innerText = co2; 
            document.getElementById('ana-water').innerText = (totalWeight * 26.5).toFixed(0);
            document.getElementById('dash-water').innerText = (totalWeight * 26.5).toFixed(0) + ' L';
            document.getElementById('ana-trees').innerText = (totalWeight * 0.017).toFixed(2);
            document.getElementById('dash-trees').innerText = (totalWeight * 0.017).toFixed(2);
            document.getElementById('ana-energy').innerText = (totalWeight * 4.2).toFixed(1);
            document.getElementById('dash-energy').innerText = (totalWeight * 4.2).toFixed(1) + ' kWh';

            const donutCtx = document.getElementById('wasteDoughnut');
            const trendCtx = document.getElementById('trendChart');

            if(donutCtx) {
                const types = {}; pickups.forEach(p => types[p.type] = (types[p.type] || 0) + 1);
                if(donutInstance) donutInstance.destroy();
                donutInstance = new Chart(donutCtx, { 
                    type: 'doughnut', 
                    data: { labels: Object.keys(types), datasets: [{ data: Object.values(types), backgroundColor: ['#22c55e', '#3b82f6', '#a855f7', '#f97316'] }] },
                    options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                });
            }

            if(trendCtx) {
                if(trendInstance) trendInstance.destroy();
                trendInstance = new Chart(trendCtx, {
                    type: 'line',
                    data: { labels: ['Sep', 'Oct', 'Nov', 'Dec'], datasets: [{ label: 'Waste (kg)', data: [12, 19, 15, totalWeight], borderColor: '#22c55e', tension: 0.4 }] },
                    options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
                });
            }
        }

        app.switchHubTab = (tab) => {
            document.getElementById('tab-leaderboard').classList.remove('active');
            document.getElementById('tab-rewards').classList.remove('active');
            document.getElementById('hub-content-leaderboard').classList.add('hidden');
            document.getElementById('hub-content-rewards').classList.add('hidden');
            
            document.getElementById('tab-' + tab).classList.add('active');
            document.getElementById('hub-content-' + tab).classList.remove('hidden');
            if(tab === 'leaderboard') app.loadLeaderboard();
        };

        app.switchView = (viewId) => { 
            ['dashboard','schedule','history','rewards-hub','settings','analytics','report'].forEach(id => { 
                const v = document.getElementById('view-'+id); if(v) v.classList.add('hidden'); 
                const n = document.getElementById('nav-'+id); if(n) n.classList.remove('active'); 
            }); 
            document.getElementById('view-'+viewId).classList.remove('hidden'); 
            document.getElementById('nav-'+viewId).classList.add('active'); 
            if(viewId === 'rewards-hub') app.switchHubTab('rewards'); 
            if(window.innerWidth < 768) app.toggleSidebar(); 
        };

        app.toggleSidebar = () => { document.getElementById('sidebar').classList.toggle('-translate-x-full'); document.getElementById('sidebar-overlay').classList.toggle('open'); };
        app.toggleProfileMenu = () => { document.getElementById('profile-menu').classList.toggle('hidden'); document.getElementById('profile-overlay').classList.toggle('hidden'); };
        
        app.filterRewards = (c, b) => { 
             document.querySelectorAll('.reward-card').forEach(e => { 
                if(c==='all' || e.classList.contains('category-'+c)) { e.classList.remove('hidden'); e.classList.add('fade-in'); } 
                else { e.classList.add('hidden'); } 
            }); 
            document.querySelectorAll('.filter-btn').forEach(x => x.className='filter-btn px-5 py-2.5 bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 text-sm font-bold rounded-full border border-slate-200 transition-all hover:bg-slate-50'); 
            b.className='filter-btn active px-5 py-2.5 bg-midnight text-white text-sm font-bold rounded-full shadow-md'; 
        };

        app.redeemReward = (title, pts) => {
            if(userPoints < pts) return showToast("Insufficient Points!", "error");
            if(!confirm(`Redeem ${title} for ${pts} points?`)) return;
            spentPoints += pts;
            localStorage.setItem('eco_spentPoints', spentPoints);
            updateUI(allPickupsData);
            document.getElementById('redeem-title').innerText = title;
            document.getElementById('redeem-code').innerText = "ECO-" + Math.random().toString(36).substr(2, 6).toUpperCase();
            document.getElementById('redeem-modal').classList.remove('hidden');
            document.getElementById('redeem-modal').classList.add('flex');
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        };

        app.copyCode = () => {
            const code = document.getElementById('redeem-code').innerText;
            navigator.clipboard.writeText(code);
            showToast("Code Copied!");
        };

        // --- UPDATED SAVE PROFILE LOGIC ---
        app.saveProfile = async (e) => { 
            e.preventDefault(); 
            const updatedData = {
                firstName: document.getElementById('settings-fname').value,
                lastName: document.getElementById('settings-lname').value,
                phoneNumber: document.getElementById('settings-phone').value,
                address: document.getElementById('settings-address').value,
                emailNotifs: document.getElementById('settings-notif-email').checked,
                smsNotifs: document.getElementById('settings-notif-sms').checked
            };

            try { 
                await updateDoc(doc(db, "users", currentUser.uid), updatedData); 
                showToast('Profile & Settings saved!'); 
            } catch(err) { 
                console.error(err);
                showToast('Error saving settings', 'error'); 
            } 
        };

        app.toggleDarkMode = () => document.documentElement.classList.toggle('dark');
        app.logout = () => { if(confirm("Log out?")) signOut(auth).then(() => window.location.href = 'index.html'); };
        
        async function loadUserData(uid) { 
            try { 
                const s = await getDoc(doc(db, "users", uid)); 
                if(s.exists()) { 
                    const d = s.data(); 
                    currentUserName = d.firstName + " " + (d.lastName || "");
                    
                    document.getElementById('header-username').innerText = d.firstName; 
                    document.getElementById('avatar').innerText = d.firstName.charAt(0); 
                    
                    // Fill Form
                    document.getElementById('settings-fname').value = d.firstName || ''; 
                    document.getElementById('settings-lname').value = d.lastName || ''; 
                    document.getElementById('settings-email').value = d.email || ''; 
                    document.getElementById('settings-phone').value = d.phoneNumber || '';
                    document.getElementById('settings-address').value = d.address || '';
                    document.getElementById('settings-notif-email').checked = d.emailNotifs || false;
                    document.getElementById('settings-notif-sms').checked = d.smsNotifs || false;

                    document.getElementById('dropdown-name').innerText = d.firstName; 
                    document.getElementById('dropdown-email').innerText = d.email; 
                    document.getElementById('report-name').value = d.firstName + ' ' + d.lastName; 
                } 
            } catch(e) {} 
        }
        function setupClock() { setInterval(() => { const n = new Date(); document.getElementById('clock-time').innerText = n.toLocaleTimeString('en-IN', { timeZone: 'Asia/Kolkata', hour12: false }); document.getElementById('clock-date').innerText = n.toLocaleDateString('en-IN', { timeZone: 'Asia/Kolkata', weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); }, 1000); }
        function showToast(m, t='success') { const x = document.getElementById('toast'); document.getElementById('toast-msg').innerText = m; x.className = `fixed bottom-5 right-5 px-6 py-3 rounded-lg shadow-xl transform transition-all duration-300 z-50 flex items-center gap-3 ${t==='error'?'bg-red-500 text-white':'bg-midnight text-white'}`; x.classList.remove('translate-y-20', 'opacity-0'); setTimeout(() => x.classList.add('translate-y-20', 'opacity-0'), 3000); }
    </script>
</body>
</html>